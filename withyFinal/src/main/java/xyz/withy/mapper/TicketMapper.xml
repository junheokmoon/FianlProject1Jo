<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="xyz.withy.mapper.TicketMapper">

	<insert id="insertTicket">
	<!-- 생각해보니 티켓은 시퀀스 않쓰는구나 ㅋㅋㅋ 
	 -->
		<selectKey resultType="int" keyProperty="ticketNo" order="BEFORE"> 
		select ticket_seq.nextval from dual
		</selectKey>
		insert into ticket values(#{ticketCode}, #{ticketPrice}, #{ticketImage1}
		, #{ticketImage2}, #{ticketOttNo}, #{ticketMonth} , 1 , #{ticketNo})
	</insert>
	
	<update id="updateTicket">
		update ticket set ticket_code = #{ticketCode}, ticket_price =#{ticketPrice}, ticket_image1=#{ticketImage1}
		, ticket_image2=#{ticketImage2}, ticket_ott_no=#{ticketOttNo}, ticket_month=#{ticketMonth}
		where ticket_code = #{ticketCode}
	</update>

	<update id="deleteTicket">
		update ticket set ticket_status = 2 where ticket_code = #{ticketCode}
	</update>
	
	<delete id="realDeleteTicket">
		delect from ticket where ticket_code = #{ticketCode}
	</delete>
	
	<update id="recoverTicket">
		update ticket set ticket_status = 1 where ticket_code = #{ticketCode}
	</update>
	
	<select id="selectTicket" resultType="TicketDTO">
		select ticket_code, ticket_price, ticket_image1, ticket_image2, ticket_ott_no
		, ticket_month, ticket_status, ticket_no from ticket where ticket_code = #{ticketCode}
	</select>

	<select id="selectTicketInfo" resultType="TicketDTO">
		select ticket_code, ticket_price, ticket_image1, ticket_image2, ticket_ott_no
		    , ticket_month, ticket_status, ticket_no, ott_name, ott_image, ott_cd
		    from ticket left join ottkind on ticket_ott_no = ott_no where ticket_code=#{ticketCode} order by ticket_no desc
	</select>
	
	<select id="selectTicketCount"  resultType="int">
		select count(*) from ticket
	</select>
	
	
	<resultMap type="TicketDTO" id="ticketListResultMap">
		<id property="ticketCode" column="ticket_code"/>
		<result property="ticketPrice" column="ticket_price"/>
		<result property="ticketImage1" column="ticket_image1"/>
		<result property="ticketImage2" column="ticket_image2"/>
		<result property="ticketOttNo" column="ticket_ott_no"/>
		<result property="ticketMonth" column="ticket_month"/>
		<result property="ticketStatus" column="ticket_status"/>
		<result property="ticketNo" column="ticket_no"/>
		
		<association property="ottkindDTO" javaType="OttkindDTO">
			<result property="ottName" column="ott_name"/>
			<result property="ottImage" column="ott_image"/>
			<result property="ottCd" column="ott_cd"/>
		</association>
	</resultMap>
	
	<select id="selectTicketList" resultMap="ticketListResultMap"><!-- 전체 상품(이용권) 보기 -->
	 <!-- select t.ticket_code, t.ticket_price, t.ticket_image1, t.ticket_image2, t.ticket_ott_no, t.ticket_month, t.ticket_status, t.ticket_no, o.ott_name, o.ott_image, o.ott_cd
		from ticket t left join ottkind o on t.ticket_ott_no = o.ott_no order by t.ticket_no desc -->
		select 
		    t.ticket_code, 
		    t.ticket_price, 
		    t.ticket_image1, 
		    t.ticket_image2, 
		    t.ticket_ott_no, 
		    t.ticket_month, 
		    t.ticket_status, 
		    t.ticket_no,
		    ok.ott_name,
		    ok.ott_image,
		    ok.ott_cd
		from 
		    ticket t
		    inner join ottkind ok on t.ticket_ott_no = ok.ott_no
		order by
		    case 
		        when t.ticket_ott_no = 21 then
		            case t.ticket_month
		                when 1 then 1
		                when 3 then 2
		                when 6 then 3
		                when 9 then 4
		                when 12 then 5
		            end
		        when t.ticket_ott_no = 25 then
		            case t.ticket_month
		                when 1 then 6
		                when 3 then 7
		                when 6 then 8
		                when 9 then 9
		                when 12 then 10
		            end
		    end
	</select>
	
	<select id="selectTicketPageList" resultType="TicketDTO">
		select * from (rownum rn ticket.* (select ticket_code, ticket_price, ticket_image1, ticket_image2, ticket_ott_no
		, ticket_month, ticket_status ,ticket_no from ticket order by ticket_no desc)ticket) where rn between #{startRow} and #{endRow}
	</select>
	

	<select id="selectTicketMonthList" resultType="int">
		select distinct ticket_month from ticket order by ticket_month asc
	</select>


</mapper>